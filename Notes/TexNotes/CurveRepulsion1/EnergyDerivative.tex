%        File: EnergyDerivative.tex
%     Created: Fri Feb 17 06:00 PM 2023 G
% Last Change: Fri Feb 17 06:00 PM 2023 G
%
\documentclass[a4paper]{article}

\usepackage{mathtools}
\usepackage{amssymb}
\usepackage[]{amsmath}

\newcommand{\x}{\mathbf{x}}
\newcommand{\dx}{\,\text{d}x}
\newcommand{\dy}{\,\text{d}y}
\newcommand{\norm}[1]{||#1||}
\newcommand{\inner}[1]{\langle \langle #1 \rangle \rangle}

\DeclareMathOperator{\grad}{grad}
\DeclareMathOperator{\Var}{Var}

\begin{document}
The \textbf{discretized energy} $E$ can be expressed as:
\begin{align}
    E &= \sum_{i = 1}^{J} \sum_{\substack{j = 1 \\ |j-i| > 1}} k_{i,j} \norm{x_{i+1} - x_i} \, \norm{x_{j+1} - x_j} 
    \label{equ: Discretized Energy}
    \\
    k_{i,j} &= \frac{1}{4} \left( 
        k_{\beta}^{\alpha} \left( x_i, x_j, T_i \right)
        + k_{\beta}^{\alpha} \left( x_i, x_{j+1}, T_i \right)
        + k_{\beta}^{\alpha} \left( x_{i+1}, x_j, T_i \right)
        + k_{\beta}^{\alpha} \left( x_{i+1}, x_{j+1}, T_i \right)
    \right)
\end{align}
where we index cyclically.

For derivative with respect to $x_k$ (note that it is a vector), the only terms indexed by
$(i,j)$ that involves $x_k$ are enumerated by the following indices:
\begin{itemize}
    \item $(k,1)$, $\cdots$, $(k, k-2)$, $(k, k+2)$, $\cdots$, $(k,J)$
    \item $(k-1,1)$, $\cdots$, $(k-1, k-3)$, $(k-1, k+1)$, $\cdots$, $(k-1,J)$
    \item $(1,k)$, $\cdots$, $(k-2, k)$, $(k+2, k)$, $\cdots$, $(J,k)$
    \item $(1,k-1)$, $\cdots$, $(k-3, k-1)$, $(k+1, k-1)$, $\cdots$, $(J,k-1)$
\end{itemize}

We now attempt to construct derivative (in a ``modular fashion'').
Write 
\begin{align}
    k_{\beta}^{\alpha} \left( x_p, x_q, T_r \right) &= k_{\beta}^{\alpha} \left( x_p, x_q, \frac{x_{r+1} - x_{r}}{\norm{x_{r} - x_{r+1}}} \right) \nonumber
    \\
    &= \frac{\sqrt{\norm{x_{r+1} - x_r}^2 \norm{x_p - x_q}^2- \left( \left( x_{r+1} - x_{r} \right) \cdot \left( x_{p} - x_{q} \right) \right)^2}^{\alpha} }{\norm{x_p - x_q}^{\beta} \norm{x_r - x_{r+1}}^{\alpha}} \nonumber \\
    &= \frac{\xi_{p,q,r}^{\alpha/2}}{\eta_{p,q,r}}
\end{align}
where
\begin{align}
    \xi_{p,q,r} &= \norm{x_{r+1} - x_r}^2 \norm{x_p - x_q}^2- \left( \left( x_{r+1} - x_{r} \right) \cdot \left( x_{p} - x_{q} \right) \right)^2 \\
    \eta_{p,q,r} &= \norm{x_p - x_q}^{\beta} \norm{x_r - x_{r+1}}^{\alpha}
\end{align}

Derivative with respect to $x_k$ can now be written as:
\begin{equation}
    \frac{\partial}{\partial x_k} \left( \frac{\xi^{\alpha/2}}{\eta} \right) = \frac{1}{\eta^2} \left( \frac{\alpha}{2} \xi^{\alpha/2 - 1} \frac{\partial \xi}{\partial x_k} \eta - \xi^{\alpha/2} \frac{\partial \eta}{\partial x_k} \right)
\end{equation}
where $p,q,r$ are omitted.

\section{$(p,q,r) = (k, j, k)$}
\begin{align}
    \xi_{k,j,k} &= \norm{x_{k+1} - x_k}^2 \norm{x_k - x_j}^2- \left( \left( x_{k+1} - x_{k} \right) \cdot \left( x_{k} - x_{j} \right) \right)^2 \\
    \eta_{k,j,k} &= \norm{x_k - x_j}^{\beta} \norm{x_k - x_{k+1}}^{\alpha}
\end{align}
Taking derivative of $\xi_{k,j,k}$ with respect to $x_k$,
\begin{align}
    \frac{\partial \xi_{k,j,k}}{\partial x_k} &= 2\left( x_k - x_{k+1} \right) \norm{x_k - x_j}^2 \\
    &+ 2 \norm{x_{k+1} - x_k}^2 \left( x_k - x_j \right) \\
    &- 2 \left( x_{k+1} - x_k \right) \cdot \left( x_k - x_j \right) \left( x_j + x_{k+1} - 2 x_k \right)
\end{align}
Taking derivative of $\eta_{k,j,k}$ with respect to $x_k$,
\begin{align}
    \frac{\partial \eta_{k,j,k}}{\partial x_k} &= \beta \norm{x_k - x_j}^{\beta - 2} \norm{x_k - x_{k+1}}^{\alpha} \left( x_k - x_j \right)\\
    &+ \alpha \norm{x_k - x_j}^{\beta} \norm{x_k - x_{k+1}}^{\alpha - 2} \left( x_k - x_{k+1} \right)
\end{align}

\section{$(p,q,r) = (i, j, k)$ where $i \neq k$ or $i \neq k-1$}
\begin{align}
    \xi_{i,j,k} &= \norm{x_{k+1} - x_k}^2 \norm{x_i - x_j}^2- \left( \left( x_{k+1} - x_{k} \right) \cdot \left( x_{i} - x_{j} \right) \right)^2 \\
    \eta_{i,j,k} &= \norm{x_i - x_j}^{\beta} \norm{x_k - x_{k+1}}^{\alpha}
\end{align}
Taking derivative of $\xi_{i,j,k}$ with respect to $x_k$,
\begin{align}
    \frac{\partial \xi_{i,j,k}}{\partial x_k} &= 2 \norm{x_i - x_j}^2 \left( x_k - x_{k+1} \right) \\
    &- 2 \left( x_{k+1} - x_k \right) \cdot \left( x_i - x_j \right) \left( x_j - x_i \right)
\end{align}
Taking derivative of $\eta_{i,j,k}$ with respect to $x_k$,
\begin{align}
    \frac{\partial \eta_{i,j,k}}{\partial x_k} &= \alpha \norm{x_i - x_j}^{\beta} \norm{x_k - x_{k+1}}^{\alpha - 2} \left( x_k - x_{k+1} \right)
\end{align}

\end{document}


